<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<style>
/* KINETIC VISUAL CORE */
:root{ --bg:#000000; --card:#0a0a0a; --border:#222; --gold:#ffd600; --green:#2ecc71; --red:#ff4444; --text-white:#ffffff; --text-grey:#888888; --font-serif:'Crimson Text',serif; --font-sans:'Inter',sans-serif; --font-code:'JetBrains Mono',monospace; }
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
body{margin:0; height:100vh; background:var(--bg); color:var(--text-white); font-family:var(--font-sans); overflow:hidden; display:flex; flex-direction:column;}
#view-portal, #view-quiz { position:absolute; inset:0; display:flex; flex-direction:column; background:var(--bg); transition:opacity 0.3s; z-index:10; }
.hidden { opacity:0; pointer-events:none; z-index:0 !important; }
.portal-header { padding:20px; border-bottom:1px solid var(--border); background:rgba(10,10,10,0.9); }
.portal-title { font-family:var(--font-code); color:var(--gold); font-size:0.8rem; letter-spacing:2px; margin-bottom:5px; }
.portal-syllabus { font-family:var(--font-serif); font-size:1.4rem; line-height:1.2; }
.video-widget { margin:20px; padding:15px; border:1px solid var(--border); border-radius:8px; background:var(--card); display:flex; align-items:center; justify-content:space-between; }
.video-status { font-family:var(--font-code); font-size:0.75rem; color:var(--text-grey); }
.video-timer { font-family:var(--font-code); font-size:1rem; color:var(--text-white); font-weight:bold; }
.btn-watch { background:var(--bg); color:var(--text-grey); border:1px solid var(--border); padding:8px 16px; border-radius:4px; font-family:var(--font-code); font-size:0.7rem; pointer-events:none; transition:all 0.3s; }
.btn-watch.ready { background:var(--red); color:white; border-color:var(--red); pointer-events:auto; box-shadow:0 0 15px rgba(255,68,68,0.4); }
.mission-grid { flex:1; overflow-y:auto; padding:20px; display:grid; gap:15px; align-content:start; }
.mission-card { background:var(--card); border:1px solid var(--border); padding:20px; border-radius:12px; cursor:pointer; }
.mission-tag { font-family:var(--font-code); font-size:0.6rem; color:var(--gold); border:1px solid var(--gold); padding:2px 6px; border-radius:4px; display:inline-block; margin-bottom:10px; }
.mission-name { font-family:var(--font-serif); font-size:1.2rem; margin-bottom:5px; }
.mission-meta { font-size:0.8rem; color:var(--text-grey); }
.quiz-card { flex:1; padding:20px; display:flex; flex-direction:column; justify-content:center; }
.q-text { font-family:var(--font-serif); font-size:1.3rem; margin-bottom:30px; }
.opt-btn { background:var(--card); border:1px solid #333; color:#ccc; padding:15px; margin-bottom:10px; border-radius:8px; text-align:left; width:100%; }
.opt-btn.selected { border-color:var(--gold); color:var(--gold); background:rgba(255,214,0,0.05); }
.btn-main { width:100%; padding:15px; background:var(--text-white); color:black; border:none; border-radius:8px; font-weight:bold; margin-top:20px; }
#feedback-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; display:flex; flex-direction:column; justify-content:center; align-items:center; pointer-events:none; opacity:0; transition:opacity 0.2s; }
#feedback-overlay.visible { opacity:1; pointer-events:auto; }
</style>
</head>
<body>

<div id="view-portal">
    <div class="portal-header">
        <div class="portal-title">DECIDE OS LINK // ACTIVE</div>
        <div class="portal-syllabus" id="portal-topic">Initializing...</div>
    </div>
    
    <div class="video-widget">
        <div>
            <div class="video-status" id="video-msg">NEURAL RENDERING</div>
            <div class="video-timer" id="video-timer">Checking...</div>
        </div>
        <button class="btn-watch" id="btn-video" onclick="openVideo()">VIDEO LOCKED</button>
    </div>

    <div class="mission-grid" id="mission-list"></div>
</div>

<div id="view-quiz" class="hidden">
    <div class="portal-header" style="display:flex; justify-content:space-between;">
        <span onclick="goBack()">EXIT</span>
        <span id="quiz-progress">1 / 5</span>
    </div>
    <div class="quiz-card" id="q-container"></div>
    <div style="padding:20px"><button class="btn-main" onclick="submitAnswer()">CONFIRM</button></div>
</div>

<div id="feedback-overlay">
    <div style="font-size:3rem" id="fb-icon"></div>
    <div style="font-family:serif; font-size:1.5rem" id="fb-text"></div>
    <button class="btn-main" style="width:auto; padding:10px 40px" onclick="nextQuestion()">NEXT</button>
</div>

<script>
// ðŸ”´ CONFIGURATION ZONE
// This uses your specific Deployment ID ending in ...DG2Zs
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxxh1ZwNRwqsSW1Lf62eh2wiwaNKzHWX8Icq472NQVj7-yEvOYuTDuiEGmelW_DG2Zs/exec";
// Sheet ID Reference: 1MLL4yyhzEebd2-_iMSA90FGJ3VuBrVV2drcGYAsLmnA

const DEFAULT_VIDEO = "https://youtube.com/@decide.engine"; 
const RENDER_TIME_MS = 60 * 60 * 1000; // 1 Hour Timer

let STATE = { mode: 'default', syllabus: [], session_id: null, video_url: null, active_q: null, score: 0 };

const RAW_DATA = [
    { text: "What defines a 'Bear Market'?", options: ["20% Drop", "10% Correction", "Flat"], ans: 0 },
    { text: "Which entity controls rates?", options: ["Fed", "Treasury", "Banks"], ans: 0 },
    { text: "Effect of ionic strength?", options: ["Increase", "Decrease", "None"], ans: 0 }
];

function boot() {
    const urlParams = new URLSearchParams(window.location.search);
    STATE.session_id = urlParams.get('session');
    const syllabus = urlParams.get('syllabus');
    
    if(STATE.session_id && syllabus) {
        STATE.syllabus = syllabus.split('|');
        initPortal();
        initVideoLogic(); // ðŸŸ¢ Start Polling Backend for Video Link
    } else {
        document.getElementById('portal-topic').innerText = "DEMO MODE (No Link)";
        STATE.syllabus = ["Demo Topic 1", "Demo Topic 2"];
        initPortal();
    }
}

function initPortal() {
    document.getElementById('portal-topic').innerText = STATE.syllabus[0] || "Unknown";
    const grid = document.getElementById('mission-list');
    grid.innerHTML = "";
    STATE.syllabus.forEach((topic, idx) => {
        const el = document.createElement('div');
        el.className = 'mission-card';
        el.innerHTML = `<div class="mission-tag">LEVEL ${idx}</div><div class="mission-name">${topic}</div>`;
        el.onclick = () => startLevel(topic);
        grid.appendChild(el);
    });
}

function initVideoLogic() {
    // 1. Start Persistent Timer
    let start = localStorage.getItem('render_' + STATE.session_id);
    if(!start) { start = Date.now(); localStorage.setItem('render_' + STATE.session_id, start); }
    const target = parseInt(start) + RENDER_TIME_MS;

    setInterval(() => {
        const diff = target - Date.now();
        const el = document.getElementById('video-timer');
        
        // If URL found via Backend Poll
        if(STATE.video_url) {
            el.innerText = "READY";
            unlockVideo();
        } 
        // If Time Up but no URL yet
        else if (diff <= 0) {
            el.innerText = "00:00";
            document.getElementById('video-msg').innerText = "RENDERING FINALIZED...";
        } 
        // Counting Down
        else {
            const m = Math.floor(diff/60000);
            el.innerText = `${m}m remaining`;
        }
    }, 1000);

    // 2. Poll Backend every 5 seconds for the URL
    setInterval(() => {
        if(!STATE.video_url) {
            fetch(`${BACKEND_URL}?action=check_video&session=${STATE.session_id}`)
                .then(r => r.json())
                .then(data => {
                    if(data.video_url) {
                        STATE.video_url = data.video_url;
                        unlockVideo();
                    }
                });
        }
    }, 5000);
}

function unlockVideo() {
    const btn = document.getElementById('btn-video');
    btn.classList.add('ready');
    btn.innerText = "â–¶ WATCH BRIEFING";
    document.getElementById('video-msg').innerText = "BRIEFING READY";
}

function openVideo() {
    if(STATE.video_url) window.open(STATE.video_url, '_blank');
    else if (document.getElementById('btn-video').innerText.includes("WATCH")) window.open(DEFAULT_VIDEO, '_blank');
}

function startLevel(topic) {
    document.getElementById('view-portal').classList.add('hidden');
    document.getElementById('view-quiz').classList.remove('hidden');
    // In production, this filters your 215 unit database. For now, random demo.
    STATE.active_q = RAW_DATA[Math.floor(Math.random()*RAW_DATA.length)];
    renderQuestion();
}

function renderQuestion() {
    document.getElementById('q-container').innerHTML = `<div class="q-text">${STATE.active_q.text}</div>` + 
        STATE.active_q.options.map((o,i) => `<button class="opt-btn" onclick="sel(${i})" id="o${i}">${o}</button>`).join('');
}

let selIdx = -1;
window.sel = (i) => { selIdx = i; document.querySelectorAll('.opt-btn').forEach(b=>b.classList.remove('selected')); document.getElementById('o'+i).classList.add('selected'); }

window.submitAnswer = () => {
    if(selIdx === -1) return;
    const isCorrect = selIdx === STATE.active_q.ans;
    document.getElementById('feedback-overlay').classList.add('visible');
    document.getElementById('fb-icon').innerText = isCorrect ? "ðŸ’Ž" : "âŒ";
    document.getElementById('fb-text').innerText = isCorrect ? "SUCCESS" : "FAIL";
    
    // ðŸ“¡ SEND ANSWER TO SHEET
    fetch(BACKEND_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({
        event: "ANSWER", session_id: STATE.session_id, result: isCorrect?"PASS":"FAIL"
    })});
}

window.nextQuestion = () => {
    document.getElementById('feedback-overlay').classList.remove('visible');
    goBack();
}

window.goBack = () => {
    document.getElementById('view-quiz').classList.add('hidden');
    document.getElementById('view-portal').classList.remove('hidden');
}

boot();
</script>
</body>
</html>
