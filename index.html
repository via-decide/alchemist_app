<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Portal</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">

<style>
/* KINETIC VISUAL CORE */
:root{ --bg:#000000; --card:#0a0a0a; --border:#222; --gold:#ffd600; --green:#2ecc71; --red:#ff4444; --blue:#2979ff; --text-white:#ffffff; --text-grey:#888888; --font-serif:'Crimson Text',serif; --font-sans:'Inter',sans-serif; --font-code:'JetBrains Mono',monospace; }
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
body{margin:0; height:100vh; background:var(--bg); color:var(--text-white); font-family:var(--font-sans); overflow:hidden; display:flex; flex-direction:column;}

/* UI LAYERS */
#view-splash, #view-portal, #view-quiz, #view-result { position:absolute; inset:0; display:flex; flex-direction:column; background:var(--bg); transition:opacity 0.3s; z-index:10; }
.hidden { opacity:0; pointer-events:none; z-index:0 !important; }

/* PORTAL DASHBOARD */
.portal-header { padding:20px; border-bottom:1px solid var(--border); background:rgba(10,10,10,0.9); backdrop-filter:blur(10px); }
.portal-title { font-family:var(--font-code); color:var(--gold); font-size:0.8rem; letter-spacing:2px; margin-bottom:5px; }
.portal-syllabus { font-family:var(--font-serif); font-size:1.4rem; line-height:1.2; }

/* VIDEO WIDGET */
.video-widget { margin:20px; padding:15px; border:1px solid var(--border); border-radius:8px; background:var(--card); display:flex; align-items:center; justify-content:space-between; }
.video-status { font-family:var(--font-code); font-size:0.75rem; color:var(--text-grey); }
.video-timer { font-family:var(--font-code); font-size:1rem; color:var(--text-white); font-weight:bold; }
.btn-watch { background:var(--bg); color:var(--text-grey); border:1px solid var(--border); padding:8px 16px; border-radius:4px; font-family:var(--font-code); font-size:0.7rem; pointer-events:none; transition:all 0.3s; }
.btn-watch.ready { background:var(--red); color:white; border-color:var(--red); pointer-events:auto; box-shadow:0 0 15px rgba(255,68,68,0.4); }

/* MISSION GRID */
.mission-grid { flex:1; overflow-y:auto; padding:20px; display:grid; gap:15px; align-content:start; }
.mission-card { background:var(--card); border:1px solid var(--border); padding:20px; border-radius:12px; position:relative; overflow:hidden; transition:transform 0.2s; cursor:pointer; }
.mission-card:active { transform:scale(0.98); }
.mission-tag { font-family:var(--font-code); font-size:0.6rem; color:var(--gold); border:1px solid var(--gold); padding:2px 6px; border-radius:4px; display:inline-block; margin-bottom:10px; }
.mission-name { font-family:var(--font-serif); font-size:1.2rem; margin-bottom:5px; }
.mission-meta { font-size:0.8rem; color:var(--text-grey); }
.mission-card.locked { opacity:0.5; pointer-events:none; filter:grayscale(1); }

/* QUIZ UI */
.quiz-nav { height:60px; display:flex; align-items:center; justify-content:space-between; padding:0 20px; border-bottom:1px solid var(--border); }
.quiz-card { flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; justify-content:center; }
.q-text { font-family:var(--font-serif); font-size:1.3rem; line-height:1.5; margin-bottom:30px; }
.opt-btn { background:var(--card); border:1px solid #333; color:#ccc; padding:15px; margin-bottom:10px; border-radius:8px; text-align:left; transition:all 0.2s; }
.opt-btn.selected { border-color:var(--gold); color:var(--gold); background:rgba(255,214,0,0.05); }
.action-area { padding:20px; border-top:1px solid var(--border); }
.btn-main { width:100%; padding:15px; background:var(--text-white); color:black; border:none; border-radius:8px; font-weight:bold; font-family:var(--font-code); letter-spacing:1px; }

/* FEEDBACK OVERLAY */
#feedback-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; display:flex; flex-direction:column; justify-content:center; align-items:center; pointer-events:none; opacity:0; transition:opacity 0.2s; }
#feedback-overlay.visible { opacity:1; pointer-events:auto; }
.fb-icon { font-size:4rem; margin-bottom:20px; }
.fb-text { font-family:var(--font-serif); font-size:1.5rem; text-align:center; max-width:80%; }
.fb-sub { font-family:var(--font-code); color:var(--text-grey); margin-top:10px; font-size:0.8rem; }

</style>
</head>
<body>

<div id="view-portal">
    <div class="portal-header">
        <div class="portal-title">DECIDE OS LINK // ACTIVE</div>
        <div class="portal-syllabus" id="portal-topic">Initializing...</div>
    </div>
    
    <div class="video-widget">
        <div>
            <div class="video-status" id="video-msg">NEURAL RENDERING</div>
            <div class="video-timer" id="video-timer">59:00</div>
        </div>
        <button class="btn-watch" id="btn-video" onclick="openVideo()">VIDEO LOCKED</button>
    </div>

    <div class="mission-grid" id="mission-list">
        </div>
</div>

<div id="view-quiz" class="hidden">
    <div class="quiz-nav">
        <span onclick="goHome()" style="font-size:1.5rem; cursor:pointer;">&times;</span>
        <span id="quiz-progress" style="font-family:var(--font-code); color:var(--text-grey);">1 / 5</span>
    </div>
    <div class="quiz-card" id="q-container">
        </div>
    <div class="action-area">
        <button class="btn-main" onclick="submitAnswer()">CONFIRM TRANSMUTATION</button>
    </div>
</div>

<div id="feedback-overlay">
    <div class="fb-icon" id="fb-icon">âœ¨</div>
    <div class="fb-text" id="fb-text">Correct</div>
    <div class="fb-sub" id="fb-sub">Logic Alignment: 100%</div>
    <button class="btn-main" style="width:auto; margin-top:30px; padding:10px 30px;" onclick="nextQuestion()">CONTINUE</button>
</div>

<script>
/* =========================================
   ALCHEMIST ENGINE v2.0 | PORTAL EDITION
   ========================================= */

// ðŸŒ CONFIG
const BEACON_URL = "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec"; // ðŸ”´ REPLACE THIS LATER
const DEFAULT_VIDEO = "https://youtube.com/@decide.engine"; 
const RENDER_TIME_MS = 60 * 60 * 1000; // 1 Hour

// ðŸ§  STATE
let STATE = {
    mode: 'default',
    syllabus: [],
    session_id: null,
    current_level: 0,
    current_q_idx: 0,
    score: 0,
    video_url: null,
    timer_end: null
};

// ðŸ“¦ DATABASE (Placeholder for 215 Units - Loaded via PDF context)
// Since I cannot paste 200 items here, I will use a robust generator logic 
// that simulates the "Slicing" capability you asked for.
const RAW_DATA = [
    { id: "A_001", topic: "Stock Market", text: "What defines a 'Bear Market' in technical terms?", options: ["20% drop from recent highs", "10% correction", "Flat growth"], ans: 0, logic: "A drop of 20% or more indicates bearish sentiment." },
    { id: "A_002", topic: "Economics", text: "Which entity controls interest rates in the US?", options: ["Federal Reserve", "US Treasury", "Wall Street"], ans: 0, logic: "The Fed manages monetary policy." },
    { id: "A_003", topic: "Chemistry", text: "Identify the effect of ionic strength on rate constant.", options: ["Increases", "Decreases", "No Effect"], ans: 0, logic: "Primary kinetic salt effect." },
    // ... Imagine 200+ items here. The logic below works regardless of size.
];

/* =========================================
   INIT & PORTAL LOGIC
   ========================================= */
function boot() {
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const syllabus = urlParams.get('syllabus');
    
    // Generate Session ID
    STATE.session_id = `SES_${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
    
    if(mode === 'portal' && syllabus) {
        STATE.mode = 'portal';
        STATE.syllabus = syllabus.split('|');
        initPortal();
        initVideoTimer();
        checkBackendForVideo(); // ðŸŸ¢ Check Google Sheet for URL
    } else {
        alert("Standard Mode Loaded (Demo)");
    }
}

function initPortal() {
    document.getElementById('view-portal').classList.remove('hidden');
    document.getElementById('portal-topic').innerText = STATE.syllabus[0]; // Main Topic
    
    const grid = document.getElementById('mission-list');
    grid.innerHTML = "";
    
    STATE.syllabus.forEach((topic, idx) => {
        const el = document.createElement('div');
        el.className = `mission-card`;
        el.innerHTML = `
            <div class="mission-tag">LEVEL ${idx}</div>
            <div class="mission-name">${topic}</div>
            <div class="mission-meta">STATUS: READY TO TRANSMUTE</div>
        `;
        el.onclick = () => startLevel(topic, idx);
        grid.appendChild(el);
    });
}

/* =========================================
   DATA REFINING (THE SLICER)
   ========================================= */
function startLevel(topic, levelIdx) {
    STATE.current_level = levelIdx;
    
    // ðŸ§  REFINING LOGIC: Filter DB by Keywords
    const keywords = topic.toLowerCase().split(' ');
    let sessionQuestions = RAW_DATA.filter(q => {
        const content = (q.text + " " + q.topic).toLowerCase();
        return keywords.some(k => content.includes(k));
    });

    // Fallback if no specific matches (Prevent Empty Game)
    if(sessionQuestions.length < 1) {
        sessionQuestions = RAW_DATA.slice(0, 5); // Just grab 5 randoms for demo
    }

    STATE.active_session = sessionQuestions.slice(0, 5); // Limit to 5 per level
    STATE.current_q_idx = 0;
    STATE.score = 0;
    
    renderQuestion();
    document.getElementById('view-portal').classList.add('hidden');
    document.getElementById('view-quiz').classList.remove('hidden');
}

/* =========================================
   GAMEPLAY ENGINE
   ========================================= */
function renderQuestion() {
    const q = STATE.active_session[STATE.current_q_idx];
    const container = document.getElementById('q-container');
    document.getElementById('quiz-progress').innerText = `${STATE.current_q_idx + 1} / ${STATE.active_session.length}`;
    
    let html = `<div class="q-text">${q.text}</div>`;
    q.options.forEach((opt, i) => {
        html += `<button class="opt-btn" id="opt-${i}" onclick="selectOpt(${i})">${String.fromCharCode(65+i)}. ${opt}</button>`;
    });
    container.innerHTML = html;
}

let selectedIndex = -1;
function selectOpt(i) {
    document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById(`opt-${i}`).classList.add('selected');
    selectedIndex = i;
}

function submitAnswer() {
    if(selectedIndex === -1) return;
    const q = STATE.active_session[STATE.current_q_idx];
    const isCorrect = selectedIndex === q.ans;
    
    // Show Overlay
    const ol = document.getElementById('feedback-overlay');
    document.getElementById('fb-icon').innerText = isCorrect ? "ðŸ’Ž" : "ðŸŒ‘";
    document.getElementById('fb-text').innerText = isCorrect ? "TRANSMUTATION SUCCESS" : "IMPURITY DETECTED";
    document.getElementById('fb-sub').innerText = q.logic;
    ol.classList.add('visible');
    
    if(isCorrect) STATE.score++;
    
    // ðŸ“¡ BEACON: Send data on every answer (Micro-sync)
    sendBeacon({
        event: "ANSWER",
        q_id: q.id,
        result: isCorrect ? "PASS" : "FAIL"
    });
}

function nextQuestion() {
    document.getElementById('feedback-overlay').classList.remove('visible');
    selectedIndex = -1;
    STATE.current_q_idx++;
    
    if(STATE.current_q_idx >= STATE.active_session.length) {
        // Level Complete
        alert(`LEVEL COMPLETE. Efficiency: ${(STATE.score/STATE.active_session.length)*100}%`);
        sendBeacon({ event: "LEVEL_COMPLETE", level: STATE.current_level });
        document.getElementById('view-quiz').classList.add('hidden');
        document.getElementById('view-portal').classList.remove('hidden');
    } else {
        renderQuestion();
    }
}

/* =========================================
   VIDEO TIMER & BACKEND BRIDGE
   ========================================= */
function initVideoTimer() {
    // Check localStorage
    let start = localStorage.getItem('render_start_' + STATE.session_id);
    if(!start) {
        start = Date.now();
        localStorage.setItem('render_start_' + STATE.session_id, start);
    }
    STATE.timer_end = parseInt(start) + RENDER_TIME_MS;
    
    setInterval(updateTimer, 1000);
}

function updateTimer() {
    const now = Date.now();
    const diff = STATE.timer_end - now;
    
    const btn = document.getElementById('btn-video');
    const msg = document.getElementById('video-msg');
    const timeDisplay = document.getElementById('video-timer');
    
    if (STATE.video_url) {
        // ðŸŸ¢ VIDEO READY (From Backend)
        btn.classList.add('ready');
        btn.innerText = "â–¶ WATCH BRIEFING";
        msg.innerText = "AI RENDERING COMPLETE";
        timeDisplay.innerText = "READY";
        return;
    }

    if (diff <= 0) {
        // ðŸŸ¢ TIMER FINISHED
        btn.classList.add('ready');
        btn.innerText = "â–¶ WATCH BRIEFING";
        msg.innerText = "RENDERING COMPLETE";
        timeDisplay.innerText = "00:00";
        STATE.video_url = DEFAULT_VIDEO; // Default fallback
    } else {
        // â³ COUNTING DOWN
        const m = Math.floor(diff / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        timeDisplay.innerText = `${m}:${s < 10 ? '0'+s : s}`;
    }
}

// ðŸŸ¢ BACKEND CHECK: The "Session Raw" Logic
// This tries to fetch a config. If your Google Sheet has a matching SessionID row with a URL, it grabs it.
async function checkBackendForVideo() {
    try {
        // Simulating the fetch. In real usage, this URL points to your Google Script (GET handler)
        const response = await fetch(`${BEACON_URL}?action=check_video&session=${STATE.session_id}`);
        const data = await response.json();
        
        if(data.video_url) {
            STATE.video_url = data.video_url; // Override default
            updateTimer(); // Force update UI
        }
    } catch(e) {
        // Silent fail: just rely on timer
        console.log("Backend check silent");
    }
}

function openVideo() {
    if(STATE.video_url) window.open(STATE.video_url, '_blank');
}

/* =========================================
   DATA BEACON (GOOGLE SHEET SYNC)
   ========================================= */
function sendBeacon(payload) {
    const data = {
        ...payload,
        session_id: STATE.session_id,
        timestamp: new Date().toISOString(),
        syllabus: STATE.syllabus.join("|")
    };
    
    // Using no-cors to avoid CORS errors with Google Sheets
    fetch(BEACON_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });
}

// Start
boot();

</script>
</body>
</html>
